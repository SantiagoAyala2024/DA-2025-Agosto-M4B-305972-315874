<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero de Control del Propietario</title>
    <link rel="stylesheet" href="tableroPropietario.css">
    <script src="vistaWeb.js"></script>
    <script src="sse.js"></script>
</head>
<body>
    <script src="utilesVista.js"></script>
    <script>
        urlIniciarVista = "/propietario/vistaConectada";
        urlCierreVista = "/propietario/vistaCerrada";
    </script>
    <div class="dashboard-container">
        <!-- Header con título y botón de salir -->
        <header class="dashboard-header">
            <h1>Tablero de control del propietario</h1>
            <button class="btn-salir" id="btnSalir">Salir</button>
        </header>

        <!-- Información del propietario -->
        <div class="info-propietario">
            <h2>Resumen del propietario</h2>
            <div class="propietario-datos">
                <div class="dato">
                    <span>NOMBRE COMPLETO</span>
                    <p id="nombrePropietario">Cargando...</p>
                </div>
                <div class="dato">
                    <span>ESTADO</span>
                    <p id="estadoPropietario">Activo</p>
                </div>
                <div class="dato">
                    <span>SALDO ACTUAL</span>
                    <p id="saldoPropietario">Cargando...</p>
                </div>
            </div>
        </div>

        <!-- Grid de tablas -->
        <div class="grid-container">
            <!-- Bonificaciones asignadas -->
            <div class="grid-item">
                <h2>Bonificaciones asignadas</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Bonificación</th>
                                <th>Puesto</th>
                                <th>Fecha asignada</th>
                            </tr>
                        </thead>
                        <tbody id="tablaBonificaciones">
                            <tr><td colspan="3" class="no-notifications">Cargando bonificaciones...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Vehículos registrados -->
            <div class="grid-item">
                <h2>Vehículos registrados</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Matrícula</th>
                                <th>Modelo</th>
                                <th>Color</th>
                                <th>Tránsitos</th>
                                <th>Monto total</th>
                            </tr>
                        </thead>
                        <tbody id="tablaVehiculos">
                            <tr><td colspan="5" class="no-notifications">Cargando vehículos...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tránsitos realizados -->
            <div class="grid-item full-width">
                <h2>Tránsitos realizados</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Puesto</th>
                                <th>Matrícula</th>
                                <th>Categoría</th>
                                <th>Monto tarifa</th>
                                <th>Bonificación</th>
                                <th>Monto bonificación</th>
                                <th>Monto pagado</th>
                                <th>Fecha</th>
                                <th>Hora</th>
                            </tr>
                        </thead>
                        <tbody id="tablaTransitos">
                            <tr><td colspan="9" class="no-notifications">Cargando tránsitos...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Notificaciones del sistema -->
            <div class="grid-item full-width">
                <div class="notificaciones-header">
                    <h2>Notificaciones del sistema</h2>
                    <button id="btnBorrarNotificaciones" class="btn-borrar">Borrar notificaciones</button>
                </div>
                <div class="table-container" id="contenedorNotificaciones">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha y hora</th>
                                <th>Mensaje</th>
                            </tr>
                        </thead>
                        <tbody id="tablaNotificaciones">
                            <tr><td colspan="2" class="no-notifications">Cargando notificaciones...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script>
        urlIniciarVista = "/propietario/vistaConectada";
        urlRegistroSSE = "/propietario/registrarSSE";
        const tablaBonificaciones = document.getElementById('tablaBonificaciones');
        const tablaVehiculos = document.getElementById('tablaVehiculos');
        const tablaTransitos = document.getElementById('tablaTransitos');

        function mostrar_habilitarIngreso(habilitar){
            document.getElementById('btnBorrarNotificaciones').disabled= !habilitar;
        }

        function mostrar_bonificaciones(bonificaciones){
            if (bonificaciones && bonificaciones.length > 0) {
                tablaBonificaciones.innerHTML = '';
                bonificaciones.forEach(bonificacion => {
                    const row = tablaBonificaciones.insertRow();
                    row.insertCell(0).textContent = bonificacion.nombre || '';
                    row.insertCell(1).textContent = bonificacion.puesto || '';
                    row.insertCell(2).textContent = bonificacion.fechaAsignacion || '';
                });
            }
        }

        function mostrar_vehiculos(vehiculos){
            if (vehiculos && vehiculos.length > 0) {
                tablaVehiculos.innerHTML = '';
                vehiculos.forEach(vehiculo => {
                    const row = tablaVehiculos.insertRow();
                    row.insertCell(0).textContent = vehiculo.matricula || '';
                    row.insertCell(1).textContent = vehiculo.modelo || '';
                    row.insertCell(2).textContent = vehiculo.color || '';
                    row.insertCell(3).textContent = vehiculo.cantidadTransitos || '0';
                    row.insertCell(4).textContent = vehiculo.montoTotal ? `$ ${vehiculo.montoTotal.toFixed(2)}` : '$ 0.00';
                });
            }
        }

        function mostrar_transitos(transitos){
            if (transitos && transitos.length > 0) {
                tablaTransitos.innerHTML = '';
                transitos.forEach(transito => {
                    const row = tablaTransitos.insertRow();
                    row.insertCell(0).textContent = transito.puesto ? transito.puesto.nombre : '';
                    row.insertCell(1).textContent = transito.vehiculo ? transito.vehiculo.matricula : '';
                    row.insertCell(2).textContent = transito.vehiculo ? transito.vehiculo.categoria : '';
                    row.insertCell(3).textContent = transito.monto ? `$ ${transito.monto.toFixed(2)}` : '$ 0.00';
                    row.insertCell(4).textContent = transito.nombreBonificacion || '';
                    row.insertCell(5).textContent = transito.descuento ? `$ ${transito.descuento.toFixed(2)}` : '$ 0.00';
                    row.insertCell(6).textContent = transito.total ? `$ ${transito.total.toFixed(2)}` : '$ 0.00';
                    
                    if (transito.fecha) {
                        const fechaCompleta = new Date(transito.fecha);
                        if (!isNaN(fechaCompleta.getTime())) {
                            row.insertCell(7).textContent = fechaCompleta.toLocaleDateString('es-ES');
                            row.insertCell(8).textContent = fechaCompleta.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'});
                        } else {
                            row.insertCell(7).textContent = '';
                            row.insertCell(8).textContent = '';
                        }
                    } else {
                        row.insertCell(7).textContent = '';
                        row.insertCell(8).textContent = '';
                    }
                });
            }
        }

        function mostrar_propietario(propietario){
            if(propietario.nombreCompleto) {
                document.getElementById('nombrePropietario').textContent = propietario.nombreCompleto;
            }
            if(propietario.saldoActual !== undefined) {
                document.getElementById('saldoPropietario').textContent = `$ ${propietario.saldoActual}`;
            }
            if(propietario.estado) {
                const estadoElement = document.getElementById('estadoPropietario');
                estadoElement.textContent = propietario.estado;
                
                estadoElement.className = 'estado-' + propietario.estado.toLowerCase();
            }
        }

        function mostrar_notificaciones(notificaciones){
            const tablaNotificaciones = document.getElementById('tablaNotificaciones');
            if (notificaciones && notificaciones.length > 0) {
                tablaNotificaciones.innerHTML = '';
                notificaciones.forEach(notificacion => {
                    const row = tablaNotificaciones.insertRow();
                    if (notificacion.fecha) {
                        const fechaCompleta = new Date(notificacion.fecha);
                        if (!isNaN(fechaCompleta.getTime())) {
                            const fechaFormateada = fechaCompleta.toLocaleDateString('es-ES') + ' ' + 
                                                  fechaCompleta.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'});
                            row.insertCell(0).textContent = fechaFormateada;
                        } else {
                            row.insertCell(0).textContent = '';
                        }
                    } else {
                        row.insertCell(0).textContent = '';
                    }
                    row.insertCell(1).textContent = notificacion.mensaje || '';
                });
            } else {
                tablaNotificaciones.innerHTML = '<tr><td colspan="2" class="no-notifications">No hay notificaciones</td></tr>';
            }
        }

        document.getElementById('btnBorrarNotificaciones').addEventListener('click', function() {
            submit('/propietario/borrarNotificaciones', '');
        });

        function mostrar_notificacionesBorradas(valor) {
            if (valor) {
                document.getElementById('tablaNotificaciones').innerHTML = '<tr><td colspan="2" class="no-notifications">No hay notificaciones</td></tr>';
            }
        }

        document.getElementById('btnSalir').addEventListener('click', function() {
            submit('/acceso/logout', '');
        });

        function mostrar_logoutExitoso(urlDestino) {
            window.location.href = urlDestino;
        }

        async function mostrar_cerrarSesion(mensaje) {
            await mostrarMensaje(mensaje);
            submit('/acceso/logout', '');
        }

    </script>
</body>
</html>